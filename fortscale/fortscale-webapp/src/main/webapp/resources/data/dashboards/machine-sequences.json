{
    "dashboardId": "machine-sequences",
    "name": "{{@entityId}} - Sequenced Domains",
    "description": "Domains with multiple suffixes that this machine tried to access. An attempt to resolve multiple suffixes for the same domain name could indicate a malware trying to enumerate over automatically generated domain.",
    "controls": [
        {
            "type": "dateRange",
            "label": "For dates: ",
            "updateDataOnChange": true,
            "params": {
                "timeStart": "-1month",
                "timeEnd": "now"
            },
            "paramsTransform": {
                "timeStart": {
                    "type": "stringDate",
                    "regExp": "(\\d{4})-(\\d{2})-(\\d{2})",
                    "replaceWith": "$1$2$30000",
                    "format": "YYYY-MM-DD"
                },
                "timeEnd": {
                    "type": "stringDate",
                    "regExp": "(\\d{4})-(\\d{2})-(\\d{2})",
                    "replaceWith": "$1$2$32400",
                    "format": "YYYY-MM-DD"
                }
            },
            "paramsInitTransform": {
                "timeStart": {
                    "type": "string",
                    "regExp": "(\\d{4})(\\d{2})(\\d{2})(\\d{2})(\\d{2})",
                    "replaceWith": "$1-$2-$3",
                    "format": "YYYY-MM-DD"
                },
                "timeEnd": {
                    "type": "string",
                    "regExp": "(\\d{4})(\\d{2})(\\d{2})(\\d{2})(\\d{2})",
                    "replaceWith": "$1-$2-$3",
                    "format": "YYYY-MM-DD"
                }
            },
            "onChange": {
                "action": "setParams",
                "actionOptions": {
                    "params": {
                        "timeStart": "{{timeStart}}",
                        "timeEnd": "{{timeEnd}}"
                    },
                    "paramsTransform": {
                        "timeStart": {
                            "type": "stringDate",
                            "regExp": "(\\d{4})-(\\d{2})-(\\d{2})",
                            "replaceWith": "$1$2$30000",
                            "format": "YYYY-MM-DD"
                        },
                        "timeEnd": {
                            "type": "stringDate",
                            "regExp": "(\\d{4})-(\\d{2})-(\\d{2})",
                            "replaceWith": "$1$2$32400",
                            "format": "YYYY-MM-DD"
                        }
                    }
                }
            }
        },
        {
            "type": "search",
            "label": "Search: ",
            "settings": {
                "reports": [
                    {
                        "query": {
                            "searchId": "Search_Machines",
                            "dataSource": "splunk",
                            "options": {
                                "count": 10
                            },
                            "fields": {
                                "Result":{"type":"ip"}
                            },
                            "params": [
                                {
                                    "field": "term",
                                    "type": "string",
                                    "dashboardParam": "term"
                                }
                            ]
                        }
                    }
                ],
                "onSelect": {
                    "action": "innerUrl",
                    "actionOptions": {
                        "url": "/d/malware/e/machine/{{value}}"
                    }
                },
                "placeholder": "IP or machine name"
            }
        }
    ],
    "widgets": [
        {
            "widgetId": 3,
            "reportId": 3,
            "report": {
                "reportId": 3,
                "name": "A machine's score, over time",
                "description": "Get score for all buckets in the specified time range, for the specified machine.",
                "query": {
                    "dataSource": "splunk",
                    "searchId": "Machine_Sequences_Graph",
                    "fields": [
                        {
                            "name": "Bucket",
                            "type": "number"
                        },
                        {
                            "name": "Feature_Value",
                            "type": "float"
                        }
                    ],
                    "params": [
                        {
                            "field": "IP",
                            "type": "string",
                            "dashboardParam": "entityId"
                        },
                        {
                            "field": "timeStart",
                            "type": "string",
                            "dashboardParam": "timeStart",
                            "default": "-1month"
                        },
                        {
                            "field": "timeEnd",
                            "type": "string",
                            "dashboardParam": "timeEnd",
                            "default": "now"
                        }
                    ]
                }
            },
            "name": "A machine's score, over time",
            "width": "100%",
            "height": "220px",
            "views": [
                {
                    "type": "lineGraph",
                    "title": "Sequences value, over time",
                    "settings": {
                        "graphType": "ColumnChart",
                        "graphOptions": {
                            "vAxis": { "minValue": 0, "maxValue": 10 }
                        },
                        "height": 180,
                        "axes": {
                            "x": {
                                "field": "Bucket",
                                "values": {
                                    "type": "datetime",
                                    "startAt": "params.timeStart",
                                    "endAt": "params.timeEnd",
                                    "format": "YYYY-MM-DD HH:mm",
                                    "interval": { "value": 15, "unit": "m" },
                                    "transform": {
                                        "regExp": "(\\d{4})(\\d{2})(\\d{2})(\\d{2})(\\d{2})",
                                        "replaceWith": "$1-$2-$3 $4:$5:00"
                                    }
                                }
                            },
                            "y": "Feature_Value"
                        },
                        "labels": ["Bucket", "Sequence Length"],
                        "decimals": 2,
                        "events": [
                            {
                                "eventName": "select",
                                "setSelection": "point",
                                "scope": "point",
                                "action": "setParams",
                                "actionOptions": {
                                    "updateUrl": false,
                                    "params": {
                                        "timeStart2": "{{Bucket}}",
                                        "timeEnd2": "{{Bucket}}"
                                    },
                                    "paramsTransform": {
                                        "timeStart2": {
                                            "type": "date",
                                            "format": "YYYYMMDDHHmm"
                                        },
                                        "timeEnd2": {
                                            "type": "date",
                                            "format": "YYYYMMDDHHmm"
                                        }
                                    },
                                    "paramsOptions": {
                                        "timeStart2": {
                                            "persist": false
                                        },
                                        "timeEnd2": {
                                            "persist": false
                                        }
                                    }
                                }
                            }
                        ]
                    }
                }
            ]
        },
        {
            "report": {
                "name": "A machine's score, over time",
                "description": "Get score for all buckets in the specified time range, for the specified machine.",
                "query": {
                    "dataSource": "splunk",
                    "searchId": "Machine_Top_Sequence_Domains",
                    "options": { "count": 20 },
                    "fields": {
                        "Sequence_Name":{"type":"string"},
                        "Suffix_Name":{"type":"string" },
                        "Domain_Score":{"type":"float"},
                        "Last_Access":{"type":"date"},
                        "Number_of_Failures":{"type":"number"},
                        "Number_of_Successes":{"type":"number"},
                        "Sequence_Length": { "type": "number "}
                    },
                    "params": [
                        {
                            "field": "IP",
                            "type": "string",
                            "dashboardParam": "entityId"
                        },
                        {
                            "field": "timeStart",
                            "type": "string",
                            "dashboardParam": "timeStart",
                            "default": "-1month"
                        },
                        {
                            "field": "timeEnd",
                            "type": "string",
                            "dashboardParam": "timeEnd",
                            "default": "now"
                        },
                        {
                            "field": "timeStart",
                            "type": "string",
                            "dashboardParam": "timeStart2",
                            "default": "-1month"
                        },
                        {
                            "field": "timeEnd",
                            "type": "string",
                            "dashboardParam": "timeEnd2",
                            "default": "now"
                        },
                        {
                            "field": "count",
                            "type": "number",
                            "default": 100
                        },
                        {
                            "field": "minScore",
                            "type": "number",
                            "default": "3",
                            "dashboardParam": "domainScoreFilter"
                        },
                        {
                            "field": "minFailures",
                            "type": "number",
                            "default": "1",
                            "dashboardParam": "domainFailuresFilter"
                        },
                        {
                            "field": "head",
                            "type": "number",
                            "default": "1000"
                        }
                    ]
                }
            },
            "controls": [
                {
                    "type": "notification",
                    "showIf": "timeStart2",
                    "value": "<i class='icon-filter'></i> Showing only bucket <strong>{{@timeStart2}}</strong>",
                    "buttons": [
                        {
                            "icon": "remove-sign",
                            "tooltip": "Discard this filter",
                            "onClick": {
                                "action": "removeParams",
                                "actionOptions": {
                                    "params": ["timeStart2", "timeEnd2"]
                                }
                            }
                        }
                    ],
                    "className": "notification-danger",
                    "updateDataOnChange": true
                }
            ],
            "refreshOn": [
                "timeStart2", "timeEnd2"
            ],
            "name": "Domains with sequences",
            "width": "100%",
            "views": [
                {
                    "type": "table",
                    "title": "All suspect domains",
                    "settings": {
                        "allowPaging": false,
                        "fields": [
                            {
                                "name": "Sequence",
                                "value": "{{Sequence_Name}} ({{Sequence_Length}})",
                                "sortable": true,
                                "sortBy": "Sequence_Name",
                                "spanRowsIfEqual": true,
                                "tooltip": "The domain name, without suffix"
                            },
                            {
                                "name": "Suffix",
                                "value": "{{Suffix_Name}}",
                                "sortBy": "Suffix_Name",
                                "events": {
                                    "click": {
                                        "action": "showPopup",
                                        "actionOptions": {
                                            "popupTitle": "Domain - {{Sequence_Name}}.{{Suffix_Name}}",
                                            "width": 400,
                                            "height": 260,
                                            "dashboardId": "domain-for-sequences",
                                            "dashboardParams": {
                                                "domain": "{{Sequence_Name}}.{{Suffix_Name}}"
                                            }
                                        }
                                    }
                                },
                                "tooltip": "The domain's suffix"
                            },
                            {
                                "name": "Last access",
                                "value": "{{Last_Access}}",
                                "sortBy": "Last_Access",
                                "tooltip": "The last time the domain + suffix was accessed by this machine"
                            },
                            {
                                "name": "Score",
                                "value": "{{Domain_Score}}",
                                "sortBy": "Domain_Score",
                                "sortDirection": -1,
                                "format": "float",
                                "formatOptions": { "decimals": 2 },
                                "tooltip": "Risk Score that indicates the possibility that a domain serves as a malicious command and control, based on DNS activity analysis of IP addresses. 1 being the lowest possibility and 10 the highest.",
                                "filter": {
                                    "type": "number",
                                    "label": "Higher than:",
                                    "dashboardParam": "domainScoreFilter",
                                    "defaultValue": 3,
                                    "noFilterValue": 0,
                                    "min": 0,
                                    "max": 9,
                                    "maxlength": 5,
                                    "width": 50
                                }
                            },
                            {
                                "name": "Sequence count",
                                "value": "{{Sequence_Length}}",
                                "sortBy": "Sequence_Length",
                                "format": "int",
                                "sortDirection": -1,
                                "tooltip": "The total number of suffixes for this domain which were attempted to be accessed in the specified time frame"
                            },
                            {
                                "name": "Failures",
                                "value": "{{Number_of_Failures}}",
                                "sortBy": "Number_of_Failures",
                                "tooltip": "The number of times this machine attempted to access the domain in the specified time frame, but failed",
                                "filter": {
                                    "type": "number",
                                    "label": "At least:",
                                    "dashboardParam": "domainFailuresFilter",
                                    "defaultValue": 1,
                                    "noFilterValue": 0,
                                    "min": 0,
                                    "maxlength": 7,
                                    "width": 50
                                }
                            },
                            {
                                "name": "Successes",
                                "value": "{{Number_of_Successes}}",
                                "sortBy": "Number_of_Successes",
                                "tooltip": "The number of times this machine successfully attempted to access the domain in the specified time frame"
                            }
                        ]
                    }
                }
            ]
        }
    ]
}