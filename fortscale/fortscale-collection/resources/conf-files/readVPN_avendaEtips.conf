morphlines : [
	{
		id : morphline1
		importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]
		commands : [
			{
				split {
					inputField : message
					outputFields : [syslogPrefix,deviceVendor,deviceProduct,deviceVersion,signatureId,name,severity,extension]
					separator : "|"
				}
			}
			
			{
				tryRules {
					catchExceptions : true
					throwExceptionIfAllRulesFailed : false
					rules : [
						{
							commands : [	    
								{
									equals { 
										deviceVendor : ["Avenda"]
										deviceProduct : ["eTipsDB"]
										name : ["Start"] 
									}
								}
							]
						}
						
						{
							commands : [
								{	logDebug	{	format : "Record does not have expected values for device vendor, product and name. Dropping record: {}", args : ["@{}"] } }
								{
									dropRecord {}
								}				
							]
						}						
					]
				}
			}
			
			{
				grok {
					dictionaryString :
						"""
							DATETIMESTAMP (?<=end=)[0-9]+(?= )
							USERNAME (?<=duser=)[\S]+(?= )
							SOURCEIP (?<=src=)[0-9.]+(?= )
							LOCALIP (?<=dst=)[0-9.]+(?= )						
						"""
					findSubstrings : true
					addEmptyStrings : true
					numRequiredMatches : all
					expressions : {
						message : "%{DATETIMESTAMP:date_time_unix}|%{USERNAME:username}|%{SOURCEIP:source_ip}|%{LOCALIP:local_ip}"
					}
				}		  
			}
			
			{
				if {
					conditions : [
						{ equals { username : []  } }
					]
					then : [
						{ logDebug { format : "No username, Drop the record. Original message was: {}", args : ["@{message}"] } }
						{ dropRecord {} }
					]
				}
			}
			
			{
				if {
					conditions : [
						{ equals { username : ["unknown"]  } }
					]
					then : [
						{ logDebug { format : "Username was listed as unknown, Drop the record. Original message was: {}", args : ["@{message}"] } }
						{ dropRecord {} }
					]
				}
			}
			
			{
				setValues {
					status : ["SUCCESS"]
					hostname : [""]
					date_time: "@{date_time_unix}"
				}
			}
			
			{
				tryRules {
					catchExceptions : true
					throwExceptionIfAllRulesFailed : false
					rules : [
						{
							commands : [
								{
									convertTimestamp {
										field : date_time
										inputFormats : ["unixTimeInMillis"]
										inputTimezone : UTC
										outputFormat : "yyyy-MM-dd HH:mm:ss"
										outputTimezone : Asia/Jerusalem
									}
								}
							]
						}
						
						{
							commands : [
								{ logWarn { format : "Problem timeGenerated: {}", args : ["@{timeGenerated}"] } }
							]
						}
					]
				}
			}
	
			{
				Geolocation {
					ip_field : source_ip
					country_field : country
					region_field : region
					city_field : city
					isp_field : isp
					usage_type_field : ipusage
					country_code_field : countrycode
					longtitude_field : longtitude
					latitude_field : latitude
				}
			}
			
			{
				VPNNormalizeUsername {
					usernameField : username
					normalizedUsernameField : normalized_username
				}
			}
			
			{
				VpnSessionUpdate {
					country_code_field : countrycode
					longtitude_field : longtitude
					latitude_field : latitude
					geo_hopping_open_session_threshold : 6
					geo_hopping_close_session_threshold : 1
					session_id_field : sessionId
				}
			}
		]
	}
]