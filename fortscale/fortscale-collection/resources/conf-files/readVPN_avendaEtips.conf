morphlines : [
	{
		id : morphline1
		importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]
		commands : [			
			{
				split {
					inputField : message
					outputFields : [syslogPrefix,deviceVendor,deviceProduct,deviceVersion,signatureId,name,severity,extension]
					separator : "|"
				}
			}
			
			{
				tryRules {
					catchExceptions : true
					throwExceptionIfAllRulesFailed : false
					rules : [
						{
							commands : [	    
								{
									equals { 
										deviceVendor : ["Avenda"]
										deviceProduct : ["eTipsDB"]
										name : ["Start"] 
									}
								}
							]
						}
						
						{
							commands : [
								{	logDebug	{	format : "Record does not have expected values for device vendor, product and name. Dropping record: {}", args : ["@{}"] } }
								{
									dropRecord {}
								}				
							]
						}						
					]
				}
			}
			
			{
				grok {
					dictionaryString :
						"""
							DATETIMESTAMP (?<=end=)[0-9]+(?= )
							USERNAME (?<=duser=)[\S]+(?= )
							SOURCEIP (?<=src=)[0-9.]+(?= )
							LOCALIP (?<=dst=)[0-9.]+(?= )
							REPORTING_SERVER (?<=^.{20})\S+
			  				TIMEZONE (?<=timezone )\S+
						"""
					findSubstrings : true
					addEmptyStrings : true
					numRequiredMatches : all
					expressions : {
						message : "%{DATETIMESTAMP:date_time_unix}|%{REPORTING_SERVER:reporting_server}|%{USERNAME:username}|%{SOURCEIP:source_ip}|%{LOCALIP:local_ip}|%{TIMEZONE:timezone}"
					}
				}		  
			}
			{
				EmptyObjectFilter {
					filterFields : [username,source_ip]
				}
			}
			{
				if {
					conditions : [
						{ equals { username : ["unknown"]  } }
					]
					then : [
						{ logDebug { format : "Username was listed as unknown, Drop the record. Original message was: {}", args : ["@{message}"] } }
						{ dropRecord {} }
					]
				}
			}
			#the first overflow filter command insures that the overflow is not caused by a single user in the system
			{
				OverFlowFilter {
					eventsType : vpn
					criteria : [username]
					threshold : 100000
				}
			}
			{
				OverFlowFilter {
					eventsType : vpn
					criteria : []
					threshold : 1000000
				}
			}
			{
				if {
				  conditions : [
					{ equals { timezone : [] }}
				  ]
				  then : [
					{
						GetTimezone {
							sourceType : "vpn"
							hostnameField : reporting_server
							timezoneOutputField : timezone_input
						}
					}
				  ]
				  else : [
					{
						addValues {
							timezone_input : "@{timezone}"
						}
					}
				  ]
				}
			}
			
			
			
			{
				setValues {
					status : ["SUCCESS"]
					hostname : [""]
					date_time: "@{date_time_unix}"
				}
			}
			
			{
				tryRules {
					catchExceptions : true
					throwExceptionIfAllRulesFailed : false
					rules : [
						{
							commands : [
								{
									convertTimestampFortscale {
										field : date_time
										inputFormats : ["unixTimeInMillis"]
										inputTimezoneField : timezone_input
										outputFormat : "yyyy-MM-dd HH:mm:ss"
									}
								}
							]
						}
						
						{
							commands : [
								{ logWarn { format : "Problem timeGenerated: {}", args : ["@{timeGenerated}"] } }
							]
						}
					]
				}
			}
			

			{
				setValues {
					addsessiondata: true
				}

			}

		]
	}
]
