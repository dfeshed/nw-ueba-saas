morphlines : [
	{
	    id : morphline1
	    importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]

    	commands : [
    	{
			tryRules {
		  		catchExceptions : true
		  		throwExceptionIfAllRulesFailed : false
		  		rules : [
				{
			  		commands : [
	  				{
						grok {
							dictionaryFiles : [resources/grok-dictionaries/secevents.sa.conf]
		  					findSubstrings : true
						  	addEmptyStrings : true
						  	numRequiredMatches : all
						  	expressions : {
								message : "%{ACCOUNT_DOMAIN:account_domain}|%{USER_ID:security_id}|%{PRE_AUTHENTICATION_TYPE:authentication_type}|%{RESULT_CODE:failure_code}"
						  	}
						}
      				}
      				{ toString { field : account_domain, trim : true } }
      				{ toString { field : security_id, trim : true } }
      				{ toString { field : authentication_type, trim : true } }
      				{ toString { field : failure_code, trim : true } }
			  		]
				}
				{
					# fallback rule when grok failed to match properties
					commands : [
						{ logWarn { format : "Record does not contain proper 4768 grok fields, Drop the record. Original record was: {}", args : ["@{}"] } }
						{ dropRecord {} }    
					]
				}
		  	]
			}
		}

		{
			findReplace {
				field : security_id
				isRegex : false
				pattern : "'"
				replacement : ""
			}
		}

		{ 
			if { 
				conditions : [ 
					{ equals { account_domain : [] } } 
				] 
				then : [
					{ logWarn { format : "Record does not contain account_domain field, Drop the record. Original record was: {}", args : ["@{}"] } }
					{ dropRecord{} }
				] 
			} 
		}
		{ 
			if { 
				conditions : [ 
					{ equals { failure_code : [] } } 
				] 
				then : [
					{ logWarn { format : "Record does not contain failure_code field, Drop the record. Original record was: {}", args : ["@{}"] } }
					{ dropRecord{} }
				] 
			} 
		}
		
		{ 
			if { 
				conditions : [ 
					{ equals { isComputer : [true] } } 
				] 
				then : [
				{
				      
					FilterOUMachine {
						hostnameField : account_name
						regex : ([^ \t\n\\x0B\f\r\@]+)\$$# #$1
					}
				      
				}
				
				{
					ComputerLoginUpdate {
				    	timestampepoch_field : timeGeneratedUnixTime
				        ipaddress_field: client_address
				        hostname_field : account_name
				        domain_field : account_domain
					}
				}
				{ 
					dropRecord{} 
				}
				] 
			} 
		}
		{ 
			if { 
				conditions : [ 
					{ equals { failure_code : [0x0] } } 
				] 
				then : [
					{
						setValues {
							status : ["SUCCESS"]
						}
					}
				]
				else : [
					{
						setValues {
							status : ["FAILURE"]
						}
					}
				]
			} 
		}
		{
			if {
				conditions : [
					{ equals { status : ["SUCCESS"]  } }
				]
				then : [
					{
						UserLastActivityUpdate {
							logEventsType : login
							normalizedUsernameField : normalized_username
							epochtimestampField : timeGeneratedUnixTime
						}
					}
				]
			}
		}
		
		{
			IsSensitiveMachine {
				machineNameField : machine_name
				isSensitiveMachineField : is_sensitive_machine
			}
		} 
    	]
  	}
]
