morphlines : [
	{
	    id : morphline1
	    importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]

    	commands : [
    	{ 
			if { 
				conditions : [ 
					{ equals { isComputer : [true] } } 
				] 
				then : [
				{ logDebug { format : "Record is 4769 event for machine account, Drop the record. Original message was: {}", args : ["@{message}"] } }
				{ 
					dropRecord{} 
				}
				] 
			} 
		}
    	{
			tryRules {
		  		catchExceptions : true
		  		throwExceptionIfAllRulesFailed : false
		  		rules : [
				{
			  		commands : [
	  				{
	  					# parse message in the format: 
	  					# 2014-03-21T23:24:58.000+02:00|03/21/2014 11:24:58 PM LogName=Security SourceName=Microsoft Windows security auditing. EventCode=4769 EventType=0 Type=Information ComputerName=Fs-DC-01.Fortscale.dom TaskCategory=Kerberos Service Ticket Operations OpCode=Info RecordNumber=249579343 Keywords=Audit Success Message=A Kerberos service ticket was requested. Account Information: Account Name:	 roees@FORTSCALE.DOM Account Domain:	 FORTSCALE.DOM Logon GUID:	 {99448FA4-399E-D675-CD76-9212248B50D8} Service Information: Service Name:	 FS-DC-01$ Service ID:	 FORTSCALE\\FS-DC-01$ Network Information: Client Address:	 ::ffff:192.168.100.141 Client Port:	 58076 Additional Information: Ticket Options:	 0x40810000 Ticket Encryption Type:	0x12 Failure Code:	 0x0 Transited Services:	- This event is generated every time access is requested to a resource such as a computer or a Windows service. The service name indicates the resource to which access was requested. This event can be correlated with Windows logon events by comparing the Logon GUID fields in each event. The logon event occurs on the machine that was accessed, which is often a different machine than the domain controller which issued the service ticket. Ticket options, encryption types, and failure codes are defined in RFC 4120.
						grok {
		  					dictionaryString : """
								RECORD_NUMBER (?<=RecordNumber=)[0-9]+
								TEXT [\S]+
								 """
							findSubstrings : true
						  	addEmptyStrings : true
						  	numRequiredMatches : all
						  	expressions : {
								messageData : """%{RECORD_NUMBER:recordNumber}.+Account Domain:\s+%{TEXT:account_domain}\s.+Service Name:\s+%{TEXT:service_name}\s+Service ID:\s+%{TEXT:service_id}\s.+Failure Code:\s+%{TEXT:failure_code}"""
						  	}
						}
      				}
					{
						addValues {
							sourceName : "Microsoft Windows security auditing."
							logfile : "Security"
							categoryString : "Kerberos Service Ticket Operations"
						}
					}
      				{ toString { field : recordNumber, trim : true } }
      				{ toString { field : account_name, trim : true } }
      				{ toString { field : account_domain, trim : true } }
      				{ toString { field : service_name, trim : true } }
      				{ toString { field : service_id, trim : true } }
      				{ toString { field : failure_code, trim : true } }
			  		]
				}
				{
					# fallback rule when grok failed to match properties
					commands : [
						{ logWarn { format : "Record does not contain proper 4769 grok fields, Drop the record. Original message was: {}", args : ["@{message}"] } }
						{ dropRecord {} }    
					]
				}
		  	]
			}
		}
		{ 
			if { 
				conditions : [ 
					{ equals { service_name : [] } } 
				] 
				then : [
					{ logWarn { format : "Record does not contain service_name field, Drop the record. Original message was: {}", args : ["@{message}"] } }
					{ dropRecord {} } 
				] 
			} 
		}
		{
			if {
				conditions : [
					{ containsText { service_name : [krbtgt] } }
				]
				then : [
					{ dropRecord {} }
				]
			}
		}
		{
			FilterWhenServiceNameIsNotComputer{
				serviceName : service_name
				regex : "(.+)\\$.*# #$1"
			}
		}
		{
			java {
				imports : ""
				code: """
				Object fieldVal = record.getFirstValue("service_name");
				if (fieldVal!=null && fieldVal instanceof String) {
					String serviceName = (String)fieldVal;
					int dollar_idx = serviceName.indexOf('$');
					if ( -1 == dollar_idx ) {
						return child.process(record);
					}
					record.replaceValues("service_name", serviceName.substring(0, dollar_idx));
				}
				return child.process(record);
				"""
			}
		}




		

    	]
  	}
]
