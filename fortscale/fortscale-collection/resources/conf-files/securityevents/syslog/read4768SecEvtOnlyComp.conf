morphlines : [
{
	id : morphline1
	importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]

    commands : [
			{logDebug {format: "Debug -1 : {}", args: ["@{}"]}}
      {
           setValues {
              data_source : ["kerberos_tgt"]
              last_state : ["etl"]
           }
      }

	  	{
			tryRules {
		  		catchExceptions : true
		  		throwExceptionIfAllRulesFailed : false
		  		rules : [
				{
			  		commands : [
							{logDebug {format: "Debug -2 : {}", args: ["@{}"]}}
	  				{
						grok {
		  					dictionaryString : """
		  						CLIENT_ADDRESS (?<=Client Address:).+?(?=Client Port:)
		  						ACCOUNT_NAME (?<=Account Name:).+?(?=Supplied Realm Name)|(?<=Account Name:).+?(?=Account Domain)|(?<=Account Name:).+?(?=Service Information)
								REPORTING_SERVER (?<= \d\d:\d\d:\d\d )\S+(?= )
								ACCOUNT_DOMAIN (?<=Supplied Realm Name:).+?(?=User ID:)
			  					TIMEZONE (?<=timezone )\S+
								 """
		  					findSubstrings : true
						  	addEmptyStrings : true
						  	numRequiredMatches : all
						  	expressions : {
								message : "%{REPORTING_SERVER:reporting_server}|%{ACCOUNT_NAME:account_name}|%{CLIENT_ADDRESS:client_address}|%{ACCOUNT_DOMAIN:account_domain}|%{TIMEZONE:timezone}"
						  	}
						}
      				}
							{logDebug {format: "Debug -3 : {}", args: ["@{}"]}}
      				{ toString { field : client_address, trim : true } }
      				{ toString { field : account_name, trim : true } }
      				{ toString { field : account_domain, trim : true } }
      				{ toString { field : reporting_server, trim : true } }
					{ toString { field : timezone, trim : true } }
			  		]
				}
		  	]
			}
		}
			{logDebug {format: "Debug -4 : {}", args: ["@{}"]}}
		{
			if {
			  conditions : [
				{ equals { timezone : [] }}
			  ]
			  then : [
				{
					GetTimezone {
						sourceType : "sec"
						hostnameField : reporting_server
						timezoneOutputField : timezone_input
					}
				}
			  ]
			  else : [
				{
					addValues {
						timezone_input : "@{timezone}"
					}
				}
			  ]
			}
		}
			{logDebug {format: "Debug -5 : {}", args: ["@{}"]}}
		{
			if {
				conditions : [
					{ equals { account_name : [] } }
				]
				then : [
					{ logWarn { format : "Record does not contain account_name field, Drop the record. Original message was: {}", args : ["@{message}"] } }
					{ LogFilterEvent { errorMessage: "Record does not contain account_name field"}}
					{ dropRecord {} }
				]
			}
		}
			{logDebug {format: "Debug -6 : {}", args: ["@{}"]}}
		{
			if {
				conditions : [
					{ equals { client_address : [] } }
				]
				then : [
				{ logError { format : "Record does not contain client_address field, Drop the record. Original message was: {}", args : ["@{message}"] } }
				{ LogFilterEvent { errorMessage: "Record does not contain client_address field"}}
				{
					dropRecord{}
				}
				]
			}
		}

      { logDebug { format : "current date field at  record is - : {}", args : ["@{date_time}"] } }
			{
				AddYearToDatetime {
					dateFormat :  "yyyy MMM dd HH:mm:ss"
					timezone : timezone_input
				}
			}
			{logDebug {format: "Debug -7 : {}", args: ["@{}"]}}
			{
				addValues {
					date_time_unix : "@{date_time}"
				}
			}
			{
				convertTimestampFortscale {
					field: date_time
					inputTimezoneField: timezone_input
					outputFormat: "yyyy-MM-dd HH:mm:ss"
				}
			}
			{logDebug {format: "Debug -8 : {}", args: ["@{}"]}}
		{
			tryRules {
		  		catchExceptions : true
		  		throwExceptionIfAllRulesFailed : false
		  		rules : [
				{
			  		commands : [


							{logDebug {format: "Debug -9 : {}", args: ["@{}"]}}
				  		{
							convertTimestampFortscale {
					  			field : date_time_unix
					  			inputTimezoneField : timezone_input
					  			outputFormat : "unixTimeInSeconds"
							}
				  		}
							{logDebug {format: "Debug -10 : {}", args: ["@{}"]}}
			  		]
				}
		  		]
			}
	  	}
	  	{
			tryRules {
		  		catchExceptions : true
		  		throwExceptionIfAllRulesFailed : false
		  		rules : [
				{
			  		commands : [


							{logDebug {format: "Debug -11 : {}", args: ["@{}"]}}

				  		{
							findReplace {
					  			field : client_address
					  			pattern : "::1"
					  			isRegex : false
					  			replacement : "127.0.0.1"
					  			replaceFirst : false
							}
				  		}



				  		{
							findReplace {
					  			field : client_address
					  			pattern : "::ffff:"
					  			isRegex : false
					  			replacement : ""
				  				replaceFirst : false
							}
				  		}
					]
				}
		  		]
			}
	  	}


			{logDebug {format: "Debug -12 : {}", args: ["@{}"]}}


		{
			FilterOUMachine {
				hostnameField : account_name
				regex : "(.+)\\$$# #$1"
			}

		}
			{logDebug {format: "Debug -13 : {}", args: ["@{}"]}}
	  	{
			ComputerLoginUpdate {
		    	timestampepoch_field : date_time_unix
		        ipaddress_field: client_address
		        hostname_field : account_name
		        domain_field : account_domain
		        max_batch_size : 10000
			}
		}
			{logDebug {format: "Debug -14 : {}", args: ["@{}"]}}
    {
      addValues {
        isADHostName : true
      }
    }
			{logDebug {format: "Debug -15 : {}", args: ["@{}"]}}
	]
  }
]
