morphlines: [
  {
    id: sec4624
    importCommands: ["org.kitesdk.morphline.**", "org.apache.solr.**", "fortscale.collection.morphlines.**"]

    commands: [
      {logDebug {format: "Debug -1 : {}", args: ["@{}"]}}
      {
        grok {
          dictionaryString: """
			  	ACCOUNT_NAME (?<=Account Name:).+?(?=Account Domain:)
			  	ACCOUNT_DOMAIN (?<=Account Domain:).+?(?=Logon ID:)
			  	SOURCE_IP (?<=Source Network Address:).+?(?=Source Port:)
			  	LOGON_PROCESS (?<=Logon Process:).+?(?=\sAuthentication Package:)
			  	REPORTING_SERVER (?<= \d\d:\d\d:\d\d )\S+(?= )
			  	TIMEZONE (?<=timezone )\S+
				 """
          findSubstrings: true
          addEmptyStrings: true
          numRequiredMatches: all
          expressions: {
            message: "%{REPORTING_SERVER:reporting_server}|%{ACCOUNT_DOMAIN:account_domain}|%{ACCOUNT_NAME:account_name}|%{SOURCE_IP:source_ip}|%{LOGON_PROCESS:logon_process}|%{TIMEZONE:timezone}"
          }
        }
      }
      {logDebug {format: "Debug -2 : {}", args: ["@{}"]}}
      {toString {field: account_name, trim: true}}
      {toString {field: source_ip, trim: true}}
      {toString {field: logon_process, trim: true}}
      {toString {field: account_domain, trim: true}}
      {toString {field: reporting_server, trim: true}}
      {toString {field: timezone, trim: true}}
      {
        EmptyObjectFilter {
          filterFields: [account_name, source_ip, logon_process, reporting_server]
        }
      }
      {logDebug {format: "Debug -3 : {}", args: ["@{}"]}}
      # filter non kerberos events
      {
        if {
          conditions: [
            {not {equals {logon_process: [Kerberos]}}}
          ]
          then: [
            {LogFilterEvent {errorMessage: "Non Kerberos Event"}}
            {dropRecord {}}
          ]
        }
      }
      {logDebug {format: "Debug -4 : {}", args: ["@{}"]}}
      # filter local ip6v ip address
      {
        if {
          conditions: [
            {equals {source_ip: ["::1"]}}
          ]
          then: [
            {LogFilterEvent {errorMessage: "Local IPv6 Event"}}
            {dropRecord {}}
          ]
        }
      }
      {logDebug {format: "Debug -5 : {}", args: ["@{}"]}}
      # filter local ipv4 address
      {
        if {
          conditions: [
            {equals {source_ip: ["127.0.0.1"]}}
          ]
          then: [
            {LogFilterEvent {errorMessage: "Local IPv4 Event"}}
            {dropRecord {}}
          ]
        }
      }
      {logDebug {format: "Debug -6 : {}", args: ["@{}"]}}
      # Set account name and account domain.
      {
        java {
          imports: "import java.util.*;"
          code:
            """
            String account_name = (String)record.get("account_name").get(1);
            record.replaceValues("account_name", account_name);
            String account_domain = (String)record.get("account_domain").get(1);
            record.replaceValues("account_domain", account_domain);
            return child.process(record);
            """
        }
      }
      # filter domain servers

      {logDebug {format: "Debug -7 : {}", args: ["@{}"]}}

      # filter machines not in the desired ou
      {
        FilterOUMachine {
          hostnameField: account_name
          regex: "(.+)\\$$# #$1"
        }
      }
      {logDebug {format: "Debug -8 : {}", args: ["@{}"]}}
      # setup timestamp according to timezone of the reporting server
      {
        if {
          conditions: [
            {equals {timezone: []}}
          ]
          then: [
            {
              GetTimezone {
                sourceType: "sec"
                hostnameField: reporting_server
                timezoneOutputField: timezone_input
              }
            }
          ]
          else: [
            {
              addValues {
                timezone_input: "@{timezone}"
              }
            }
          ]
        }
      }
      {logDebug {format: "Debug -9 : {}", args: ["@{}"]}}
      {
        AddYearToDatetime {
          dateFormat: "yyyy MMM dd HH:mm:ss"
          timezone: timezone_input
        }
      }
      {logDebug {format: "Debug -10 : {}", args: ["@{}"]}}
      {
        convertTimestampFortscale {
          field: date_time
          inputTimezoneField: timezone_input
          outputFormat: "yyyy-MM-dd HH:mm:ss"
        }
      }
      {
        addValues {
          date_time_unix: "@{date_time}"
        }
      }
      {logDebug {format: "Debug -11 : {}", args: ["@{}"]}}
      {
        convertTimestampFortscale {
          field: date_time_unix
          inputTimezoneField: timezone_input
          outputFormat: "unixTimeInSeconds"
        }
      }
      {logDebug {format: "Debug -12 : {}", args: ["@{}"]}}

      # add the computer ip resolve to the cache and drop the record
      {
        ComputerLoginUpdate {
          timestampepoch_field: date_time_unix
          ipaddress_field: source_ip
          hostname_field: account_name
          domain_field: account_domain
          max_batch_size: 10000
        }
      }
      {logDebug {format: "Debug -13 : {}", args: ["@{}"]}}
      {
        addValues {
          isADHostName: true
        }
      }

      {logDebug {format: "Debug -14 : {}", args: ["@{}"]}}
    ]
  }]
