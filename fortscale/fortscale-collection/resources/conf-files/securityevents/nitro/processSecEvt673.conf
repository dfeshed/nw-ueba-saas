# DC ip,?,?,?,Event Code,?,Time stamp,?,domain?, ?, ?,   Address,Host Name,MAC Address,User Name, TransactionID, QResult,Probationtime, CorrelationID,Dhcid
# 11.178.255.45||Security||3261131673||Security||673||52||1437490334||4||TRUPDCS0003||NT AUTHORITY\SYSTEM||Account mailto:Logon%7C%7C10%7C%7CTRUVESX0028$@GCM.COM||GCM.COM||TRUPDCS0003$||%25{S-1-5-21-2000478354-616249376-682003330-101399}||0x40810000||0x17||172.21.108.203||-||{5bc0e599-d238-ea65-a185-44845d6e4cd9}||-||Service Ticket Request:%0D %0D %09User Name:%09%09TRUVESX0028$@GCM.COM%0D %0D %09User Domain:%09%09GCM.COM%0D %0D %09Service Name:%09%09TRUPDCS0003$%0D %0D %09Service ID:%09%09GCM\TRUPDCS0003$%0D %0D %09Ticket Options:%09%090x40810000%0D %0D %09Ticket Encryption Type:%090x17%0D %0D %09Client Address:%09%09172.21.108.203%0D %0D %09Failure Code:%09%09-%0D %0D %09Logon GUID:%09%09{5bc0e599-d238-ea65-a185-44845d6e4cd9}%0D %0D %09Transited Services:%09-%0D %0D

morphlines: [
  {
    id: 673SecEvent
    importCommands: ["org.kitesdk.morphline.**", "org.apache.solr.**", "fortscale.collection.morphlines.**"]
    commands: [
      {logDebug {format: "Debug -1 : {}", args: ["@{}"]}}
      {
        tryRules {
          catchExceptions: true
          throwExceptionIfAllRulesFailed: false
          rules: [
            {
              commands: [
                {logDebug {format: "Debug -2 : {}", args: ["@{}"]}}
                {
                  grok {
                    dictionaryFiles: [resources/grok-dictionaries/sec.673.conf]
                    findSubstrings: true
                    addEmptyStrings: true
                    numRequiredMatches: all
                    expressions: {
                      message: "%{TICKET_OPTIONS:ticket_options}|%{ACCOUNT_DOMAIN:account_domain}|%{SERVICE_NAME:service_name}|%{SERVICE_ID:service_id}|%{FAILURE_CODE:failure_code}"
                    }
                  }
                }
                {logDebug {format: "Debug -3 : {}", args: ["@{}"]}}
              ]
            }
          ]
        }
      }
      {logDebug {format: "Debug -4 : {}", args: ["@{}"]}}
      {
        EmptyObjectFilter {
          filterFields: [ticket_options]
        }
      }
      {logDebug {format: "Debug -5 : {}", args: ["@{}"]}}
      {
        addValues {
          computer_name: "@{reporting_server}"
          sourceName: "Microsoft Windows security auditing."
          logfile: "Security"
          categoryString: "Kerberos Service Ticket Operations"
        }
      }
      {
        if {
          conditions: [
            {equals {service_name: []}}
          ]
          then: [
            {logWarn {format: "Record does not contain service_name field, Drop the record. Original message was: {}", args: ["@{message}"]}}
            {LogFilterEvent {errorMessage: "Record does not contain service_name field"}}
            {dropRecord {}}
          ]
        }
      }
      {logDebug {format: "Debug -6 : {}", args: ["@{}"]}}
      {
        if {
          conditions: [
            {containsText {service_name: [krbtgt]}}
          ]
          then: [
            {LogFilterEvent {errorMessage: "Service name not contains krbtgt"}}
            {dropRecord {}}
          ]
        }
      }
      {logDebug {format: "Debug -7 : {}", args: ["@{}"]}}
    ]
  }
]