morphlines: [
  {
    id: verdasysEnrich
    importCommands: ["org.kitesdk.morphline.**", "org.apache.solr.**", "fortscale.collection.morphlines.**"]
    commands: [

      {logDebug {format: "Debug -2 : {}", args: ["@{}"]}}




      {
        setValues {
          normalized_src_machine:"@{domain_computer_name}"
        }
      }

      {logInfo {format: "Debug -3 : {}", args: ["@{}"]}}




      #normalized the email sender field from the pattern .+-(?=) - i.e /o=exchangelabs/ou=exchange administrative group (fydibohf23spdlt)/cn=recipients/cn=0a23953516224bca922877eb7c3efa7b-nate lord
      #   {
      #     findReplace {
      #       field: email_sender
      #       pattern: ".+-(?=)"
      #       isRegex: true
      #       replacement: ""
      #       replaceFirst: false
      #     }
      #   }

      #CALCULATE SOURCE CLASSIFICATION
      {
        java {
          imports: "import java.util.*;"
          code:
            """
               String sourceFile = (String)record.getFirstValue("source_file");
               String destFile = (String)record.getFirstValue("destination_file");

               String [] splitedSourceFile = sourceFile.split("\\.");
               String [] splitedDestFile = destFile.split("\\.");

               HashSet<String> listOfClassifiedSourceFilesTypes = new HashSet<String>(Arrays.asList("jar,db,_db,mdb,accdb,wdb,sqlite,sdf,myd,dbf,db3,sql,dbs,mdf,cpp".split(",")));
               HashSet<String> listOfClassifiedDestFilesTypes = new HashSet<String>(Arrays.asList("jar,db,_db,mdb,accdb,wdb,sqlite,sdf,myd,dbf,db3,sql,dbs,mdf,cpp".split(",")));

               boolean sourceFlag = splitedSourceFile.length>1 && listOfClassifiedSourceFilesTypes.contains(splitedSourceFile[splitedSourceFile.length-1]);
               boolean destFlag = splitedDestFile.length>1 && listOfClassifiedDestFilesTypes.contains(splitedDestFile[splitedDestFile.length-1]);



                record.replaceValues("has_src_classification",sourceFlag || destFlag);




               return child.process(record);

            """
        }
      }




      {logDebug {format: "Debug -4 : {}", args: ["@{}"]}}

      {
        setValues {
          data_source: ["dlpmail"]
          last_state: ["etl"]
          date_time_unix: "@{date_time}"
          was_rdp:["false"]
          admin_activity:["false"]
          registry_changed:["false"]
          is_attachment_mail_event:["false"]

        }
      }

      {logDebug {format: "Debug -2 : {}", args: ["@{}"]}}

      {
        convertTimestampFortscale {
          field: date_time_unix
          inputFormats : ["MM/dd/yyyy h:mm:ss a","M/dd/yyyy h:mm:ss a","MM/dd/yyyy HH:mm:ss","yyyy-MM-dd HH:mm:ss.SSS","yyyy-MM-dd HH:mm:ss","MM/dd/yyyy hh:mm:ss aaa"]
          outputFormat: "unixTimeInSeconds"
        }
      }

      {logDebug {format: "Debug -7 : {}", args: ["@{}"]}}

      {
        convertTimestampFortscale {
          field: date_time
          inputFormats : ["MM/dd/yyyy h:mm:ss a","M/dd/yyyy h:mm:ss a","MM/dd/yyyy HH:mm:ss","yyyy-MM-dd HH:mm:ss.SSS","yyyy-MM-dd HH:mm:ss","MM/dd/yyyy hh:mm:ss aaa"]
          outputFormat: "yyyy-MM-dd HH:mm:ss"
        }
      }
      {logDebug 	 {format: "Debug -8 : {}", args: ["@{}"]}}



      {logDebug {format: "Debug -9 : {}", args: ["@{}"]}}





      {
        if {
          conditions: [{contains  {account_user_id: ["NT AUTHORITY\\LOCAL SERVICE","NT AUTHORITY\\SYSTEM","NT AUTHORITY\\LOCAL SERVICE","NT AUTHORITY\\NETWORK SERVICE","NT AUTHORITY\\SYSTEM"]}}]
          then: [

            {
              EmptyObjectFilter {
                filterFields: [normalized_src_machine]
              }
            }

            {
              java {
                imports: "import java.util.*;"
                code:
                  """
                     String machineName = (String)record.getFirstValue("normalized_src_machine");
                     String accountName = (String)record.getFirstValue("account_name");


                      record.replaceValues("account_name","Device\\"+machineName);




                     return child.process(record);

                  """
              }
            }




            {
              setValues {
                normalized_src_machine : [""]
              }
            }


          ]
        }
      }



      #RDP Event mark
      {
        if {
          conditions: [{equals {application: "mstsc.exe"}}]
          then: [

            {
              setValues {
                was_rdp:["true"]
              }
            }

          ]

          else : [
            {
              #Admin Event mark
              if {
                conditions: [{contains {application: ["powershell.exe","powercfg.exe","eventvwr.exe","compmgmt.exe","taskschd.exe","secpol.exe"]}}]
                then: [

                  {
                    setValues {
                      admin_activity:["true"]
                    }
                  }

                ]
                else :[
                  {
                    #Registry changed Event mark
                    if {
                      conditions: [{contains {application: ["regedit.exe"]}}]
                      then: [

                        {
                          setValues {
                            registry_changed:["true"]
                          }
                        }

                      ]
                    }
                  }
                ]
              }
            }
          ]
        }
      }

      #Add Boolean field for sign if this event contain mail attachment
      {
        if {
          conditions:[{contains {event_description: ["Send Mail","Attach Mail"]}}]
          then: [
            {
              if{
                conditions:[{not{contains {destination_file:["message body",""]}}}]
                then:[
                  {
                    setValues {
                      is_attachment_mail_event:["true"]
                    }
                  }

                ]
              }
            }
          ]
        }
      }



      #{
      #  java{
      #    imports:"import java.util.*;"
      #    code:
      #      """
      #              String account_name = (String)record.getFirstValue("account_name");
      #              String norm = account_name+"@bankleumi.com";
      #              record.replaceValues("normalized_username",norm);
      #              return child.process(record);
      #      """
      #  }
      #}





    ]
  }

]
