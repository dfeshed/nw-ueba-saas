morphlines : [
	{
		id : morphlineEnrich
		importCommands : ["org.kitesdk.morphline.**", "org.apache.solr.**","fortscale.collection.morphlines.**"]
		commands : [



      {
        # If normalized_username is empty, and username is not empty
				if {
					conditions: [
						{ equals {normalized_username: [] } }
						{ not { equals {username: [] } } }
					]
					then: [
						{
              # Normalize username normalized_username from username
							VPNNormalizeUsername {
								usernameField: username
								normalizedUsernameField: normalized_username
							}
						}
					]
				}
			}


      # VPN session -
      # 1. create/update VPN session
      # 2. check for geohopping
      # 3. find start event to get username and other details
      # IMPORTANT: this command is using the username/normalized_username (in case we don't have session-ID)
			{
				VpnSessionUpdate {
					country_code_field : countrycode
					longtitude_field : longtitude
					latitude_field : latitude
					geo_hopping_open_session_threshold : 6
					geo_hopping_close_session_threshold : 1
					session_id_field : sessionid
					add_session_data: addsessiondata
				}
			}

			# Drop record if the following fields are empty: username
			{
				EmptyObjectFilter {
					filterFields : [username]
				}
			}



			{
        # if normalized_username is empty (but the VpnSessionUpdate found the username for the close event)
				if {
					conditions: [
						{ equals {normalized_username: [] } }
					]
					then: [
						{
              # Normalize username normalized_username from username
							VPNNormalizeUsername {
								usernameField: username
								normalizedUsernameField: normalized_username
							}
						}
					]
				}
			}


			# if VPN event is not close-session (can be SUCCESS of failure)
			{
				if {
					conditions: [{equals {status: ["CLOSED"]}}]
					then: [
						{
              #Adding data bucket
							VpnContinuousDataBucket {
								totalbytesFieldName: totalbytes
								readbytesFieldName: readbytes
								durationFieldName: duration
								databucketFieldName: databucket
							}
						}
					]
				}
			}

      # if VPN event is SUCCESS
			{
				if {
					conditions: [{equals {status: ["SUCCESS"]}}]
					then: [
						{
              # Update user activity in Mongo
							UserLastActivityUpdate {
								logEventsType: vpn
								normalizedUsernameField: normalized_username
								epochtimestampField: date_time_unix
							}
						}
					]
				}
			}


      # Update Administrator tag if needed
			{
				IsUserAdministrator {
					usernameField : normalized_username
					isUserAdministratorField : isUserAdministrator
				}
			}

      # Update Executive tag if needed
			{
				IsUserExecutive {
					usernameField : normalized_username
					isUserExecutiveField : isUserExecutive
				}
			}


		]
	}
]
