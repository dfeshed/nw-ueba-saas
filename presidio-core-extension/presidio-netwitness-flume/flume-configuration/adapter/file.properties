# Flume agent for the adapter component
# The source reads data from Netwitness SDK within a given time range
# Date format: yyyy-mm-ddTHH:mm:ss 2015-01-01T00:00:01Z
# Channel stores in file up to 10K records
# The sinks writes the records using the input SDK
###################################### AGENT #####################################################
nwFileAgent.sources=sdkSource
nwFileAgent.channels=memoryChannel
nwFileAgent.sinks=inputSdkSink
###################################### SOURCE #####################################################
nwFileAgent.sources.sdkSource.channels=memoryChannel
nwFileAgent.sources.sdkSource.streamImplClassName=presidio.nw.flume.sdk.NetwitnessEventsStream
nwFileAgent.sources.sdkSource.type=org.flume.source.sdk.PresidioStreamingSDKSource
nwFileAgent.sources.sdkSource.schema=FILE
nwFileAgent.sources.sdkSource.startDate=$startDate
nwFileAgent.sources.sdkSource.endDate=$endDate
nwFileAgent.sources.sdkSource.query=select * where device.type = 'winevent_snare' && ((reference.id = '4670','5145') || (reference.id='4660' && category='File System') || (reference.id = '4663')) && user.dst regex '^[^\\$]*$' 
#nwFileAgent.sources.sdkSource.query=select * where reference.id = '4663','4660','4670','5145'
nwFileAgent.sources.sdkSource.timeField=time
nwFileAgent.sources.sdkSource.batchSize=1000
nwFileAgent.sources.sdkSource.isBatch=true
nwFileAgent.sources.sdkSource.applicationName=adapter

############################## INTERCEPTORS ##############################
nwFileAgent.sources.sdkSource.interceptors = eventFilterByDeviceTypeAndUserDst eventFilterByCategory eventFilterByAccesses jsonRegexCaptureAndFormatInterceptorUserId eventJoinDirectoryWithFilename eventFillSrcFilePath eventFillIsSrcDriveShared eventFillOperationType eventFillOperationTypeFor4663 eventFixOperationTypeFileToFolder eventTypeToResult eventResultCodeToResult fieldRenameInterceptor
### Filtering events according to the device type and user name ###
nwFileAgent.sources.sdkSource.interceptors.eventFilterByDeviceTypeAndUserDst.type=org.apache.flume.interceptor.presidio.JsonEventFilterByFieldValueInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFilterByDeviceTypeAndUserDst.fields=device_type,user_dst
nwFileAgent.sources.sdkSource.interceptors.eventFilterByDeviceTypeAndUserDst.regexList=winevent_snare|winevent_nic,[^\\$]*
nwFileAgent.sources.sdkSource.interceptors.eventFilterByDeviceTypeAndUserDst.operation=AND
nwFileAgent.sources.sdkSource.interceptors.eventFilterByDeviceTypeAndUserDst.filter_out=false
### for 4663 and 4660: Filtering events category equals to 'File System' ###
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.type=org.apache.flume.interceptor.presidio.JsonEventFilterByFieldValueInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.condition_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.regex_condition=4663|4660
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.fields=category
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.regexList=File System
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.operation=OR
nwFileAgent.sources.sdkSource.interceptors.eventFilterByCategory.filter_out=false
### for 4663: Filtering events according to accesses field (filtering delete operations) ###
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.type=org.apache.flume.interceptor.presidio.JsonEventFilterByFieldValueInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.condition_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.regex_condition=4663
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.fields=accesses
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.regexList=DELETE|DeleteChild
nwFileAgent.sources.sdkSource.interceptors.eventFilterByAccesses.operation=OR

###  Normalize the userId values ###
nwFileAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.configuration={"sourceKey":"user_dst","destinationKey":"userId","captureAndFormatConfigurations":[{"pattern":"CN=([^,]+)","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"CN=([^,]+),.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\)+(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\)+([^@]+)","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":".+","format":"%s","capturingGroupConfigurations":[{"index":0,"caseFormat":"LOWER"}]}]}

### For 5145: joining the fields directory and filename to get the source full path ###
nwFileAgent.sources.sdkSource.interceptors.eventJoinDirectoryWithFilename.type=org.apache.flume.interceptor.presidio.JsonFieldJoinerInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventJoinDirectoryWithFilename.base_field=directory
nwFileAgent.sources.sdkSource.interceptors.eventJoinDirectoryWithFilename.to_append_field=filename
nwFileAgent.sources.sdkSource.interceptors.eventJoinDirectoryWithFilename.target_field=5145path

### Filling the srcFilePath ###
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.origin_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.destination_field=srcFilePath
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.cases_delim=,
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.cases=4663,4670,5145
nwFileAgent.sources.sdkSource.interceptors.eventFillSrcFilePath.cases_values=${obj_name};${obj_name};${5145path}

### Filling the isSrcDriveShared according to the prefix of the source file path ###
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.origin_field=srcFilePath
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.destination_field=isSrcDriveShared
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.cases_delim=,
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.cases=^//.*
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.cases_values=true
nwFileAgent.sources.sdkSource.interceptors.eventFillIsSrcDriveShared.destination_default_value=false

### For 4660, 4670 and 5145: Filling the operation type ###
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.condition_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.regex_condition=4660|4670|5145
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.origin_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.destination_field=operationType
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.cases_delim=,
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.cases=4660,4670,5145
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationType.cases_values=FILE_DELETED;FILE_PERMISSION_CHANGE;FILE_OPENED

### For 4663: Filling the operation type ###
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.condition_field=reference_id
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.regex_condition=4663
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.origin_field=accesses
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.destination_field=operationType
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.cases_delim=###
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.cases=WriteData (or AddFile)###ReadData (or ListDirectory)###AppendData (or AddSubdirectory or CreatePipeInstance)###WRITE_DAC###WRITE_OWNER
nwFileAgent.sources.sdkSource.interceptors.eventFillOperationTypeFor4663.cases_values=FILE_CREATED;FILE_OPENED;FILE_MODIFIED;FILE_WRITE_DAC_CHANGED;FILE_WRITE_OWNERSHIP_CHANGED

### Fixing the operation type from file operation to folder operation according to the file path suffix ###
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.type=org.apache.flume.interceptor.presidio.JsonSearchAndReplaceInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.condition_field=srcFilePath
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.regex_condition=.*\\$
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.fields=operationType
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.replace_strings=FOLDER_
nwFileAgent.sources.sdkSource.interceptors.eventFixOperationTypeFileToFolder.search_patterns=^FILE_

# Normalize the result values
nwFileAgent.sources.sdkSource.interceptors.eventTypeToResult.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorResult.configuration={"sourceKey":"event_type","destinationKey":"resultFromEventType","captureAndFormatConfigurations":[{"pattern":".*(?i:fail).*","format":"FAILURE"},{"pattern":".*(?i:succ).*","format":"SUCCESS"}]}

nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.origin_field=result_code
nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.destination_field=resultFromResultCode
nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.cases_delim=,
nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.cases=0x0,0x.*
nwFileAgent.sources.sdkSource.interceptors.eventResultCodeToResult.cases_values=SUCCESS;FAILURE

### Renaming fields in order to fill eventId,result,dataSource,userName,userDisplayName,dateTime
nwFileAgent.sources.sdkSource.interceptors.fieldRenameInterceptor.type = org.apache.flume.interceptor.presidio.JsonFieldRenamerInterceptor$Builder
nwFileAgent.sources.sdkSource.interceptors.fieldRenameInterceptor.originFieldsList=event_source_id,[resultFromEventType;resultFromResultCode],reference_id,userId,userId,event_time
nwFileAgent.sources.sdkSource.interceptors.fieldRenameInterceptor.destinationFieldsList=eventId,result,dataSource,userName,userDisplayName,dateTime

###################################### CHANNEL #####################################################
nwFileAgent.channels.memoryChannel.type=memory
nwFileAgent.channels.memoryChannel.capacity=100000
nwFileAgent.channels.memoryChannel.transactionCapacity=10000
###################################### SINK #####################################################
nwFileAgent.sinks.inputSdkSink.channel=memoryChannel
nwFileAgent.sinks.inputSdkSink.type=org.flume.sink.input.PresidioInputSdkSink
nwFileAgent.sinks.inputSdkSink.schema=FILE
nwFileAgent.sinks.inputSdkSink.recordType=presidio.sdk.api.domain.rawevents.FILERawEvent
nwFileAgent.sinks.inputSdkSink.isBatch=true
nwFileAgent.sinks.inputSdkSink.batchSize=1000
nwFileAgent.sinks.inputSdkSink.applicationName=adapter