# Flume agent for the adapter component
# The source reads data from the NetWitness SDK within a given time range
# Date format: yyyy-MM-ddTHH:mm:ssZ (e.g. 2015-01-01T00:00:01Z)
# Channel stores in file up to 10K records
# The sink writes the records using the input SDK
############################## AGENT ##############################
nwActive_directoryAgent.sources=sdkSource
nwActive_directoryAgent.channels=memoryChannel
nwActive_directoryAgent.sinks=inputSdkSink
############################## SOURCE ##############################
nwActive_directoryAgent.sources.sdkSource.channels=memoryChannel
nwActive_directoryAgent.sources.sdkSource.streamImplClassName=presidio.nw.flume.sdk.NetwitnessEventsStream
nwActive_directoryAgent.sources.sdkSource.type=org.flume.source.sdk.PresidioStreamingSDKSource
nwActive_directoryAgent.sources.sdkSource.schema=ACTIVE_DIRECTORY
nwActive_directoryAgent.sources.sdkSource.startDate=$startDate
nwActive_directoryAgent.sources.sdkSource.endDate=$endDate
nwActive_directoryAgent.sources.sdkSource.query=select event.time,sessionid,reference.id,user.src,group,obj.name,user.dst,event.type,event.source.id,accesses where device.type = 'winevent_snare','winevent_nic' && reference.id = '4741','4742','4733','4734','4735','4755','4740','4794','5376','5377','5136','4764','4670','4743','4739','4737','4727','4728','4754','4756','4757','4758','4720','4722','4723','4724','4725','4726','4738','4767','4717','4729','4730','4731','4732' && user.dst regex '^[^\\$]*$'
# nwActive_directoryAgent.sources.sdkSource.query=select event.time,sessionid,reference.id,user.src,group,obj.name,user.dst,event.type,event.source.id,device.type,accesses where reference.id = '4741','4742','4733','4734','4735','4755','4740','4794','5376','5377','5136','4764','4670','4743','4739','4737','4727','4728','4754','4756','4757','4758','4720','4722','4723','4724','4725','4726','4738','4767','4717','4729','4730','4731','4732'
nwActive_directoryAgent.sources.sdkSource.timeField=event.time
nwActive_directoryAgent.sources.sdkSource.batchSize=1000
nwActive_directoryAgent.sources.sdkSource.isBatch=true
nwActive_directoryAgent.sources.sdkSource.applicationName=adapter
############################## INTERCEPTORS ##############################
nwActive_directoryAgent.sources.sdkSource.interceptors=jsonRegexCaptureAndFormatInterceptorOperationType jsonConditionalArrayPopulatorInterceptor jsonFieldSwitchCaseInterceptorObjectId jsonFieldSwitchCaseInterceptorAdditionalInfo jsonEpochInterceptor jsonRegexCaptureAndFormatInterceptorUserId jsonRegexCaptureAndFormatInterceptorResult jsonFieldDuplicatorInterceptor jsonFieldRenamerInterceptor
# nwActive_directoryAgent.sources.sdkSource.interceptors=jsonEventFilterByFieldValueInterceptor jsonRegexCaptureAndFormatInterceptorOperationType jsonConditionalArrayPopulatorInterceptor jsonFieldSwitchCaseInterceptorObjectId jsonFieldSwitchCaseInterceptorAdditionalInfo jsonEpochInterceptor jsonRegexCaptureAndFormatInterceptorUserId jsonRegexCaptureAndFormatInterceptorResult jsonFieldDuplicatorInterceptor jsonFieldRenamerInterceptor

### Filter events according to device_type and user_dst ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEventFilterByFieldValueInterceptor.type=org.apache.flume.interceptor.presidio.JsonEventFilterByFieldValueInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEventFilterByFieldValueInterceptor.fields=device_type,user_dst
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEventFilterByFieldValueInterceptor.regexList=winevent_snare|winevent_nic,[^\\$]*
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEventFilterByFieldValueInterceptor.operation=AND
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEventFilterByFieldValueInterceptor.filter_out=false

### Add operationType according to reference_id ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorOperationType.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorOperationType.configuration={"sourceKey":"reference_id","destinationKey":"operationType","captureAndFormatConfigurations":[{"pattern":"4670","format":"PERMISSIONS_ON_OBJECT_CHANGED"},{"pattern":"4717","format":"SYSTEM_SECURITY_ACCESS_GRANTED_TO_ACCOUNT"},{"pattern":"4720","format":"USER_ACCOUNT_CREATED"},{"pattern":"4722","format":"USER_ACCOUNT_ENABLED"},{"pattern":"4723","format":"USER_PASSWORD_CHANGED"},{"pattern":"4724","format":"USER_PASSWORD_RESET"},{"pattern":"4725","format":"USER_ACCOUNT_DISABLED"},{"pattern":"4726","format":"USER_ACCOUNT_DELETED"},{"pattern":"4727","format":"SECURITY_ENABLED_GLOBAL_GROUP_CREATED"},{"pattern":"4728","format":"MEMBER_ADDED_TO_SECURITY_ENABLED_GLOBAL_GROUP"},{"pattern":"4729","format":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_GLOBAL_GROUP"},{"pattern":"4730","format":"SECURITY_ENABLED_GLOBAL_GROUP_DELETED"},{"pattern":"4731","format":"SECURITY_ENABLED_LOCAL_GROUP_CREATED"},{"pattern":"4732","format":"MEMBER_ADDED_TO_SECURITY_ENABLED_LOCAL_GROUP"},{"pattern":"4733","format":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_LOCAL_GROUP"},{"pattern":"4734","format":"SECURITY_ENABLED_LOCAL_GROUP_DELETED"},{"pattern":"4735","format":"SECURITY_ENABLED_LOCAL_GROUP_CHANGED"},{"pattern":"4737","format":"SECURITY_ENABLED_GLOBAL_GROUP_CHANGED"},{"pattern":"4738","format":"USER_ACCOUNT_CHANGED"},{"pattern":"4739","format":"DOMAIN_POLICY_CHANGED"},{"pattern":"4740","format":"USER_ACCOUNT_LOCKED"},{"pattern":"4741","format":"COMPUTER_ACCOUNT_CREATED"},{"pattern":"4742","format":"COMPUTER_ACCOUNT_CHANGED"},{"pattern":"4743","format":"COMPUTER_ACCOUNT_DELETED"},{"pattern":"4754","format":"SECURITY_ENABLED_UNIVERSAL_GROUP_CREATED"},{"pattern":"4755","format":"SECURITY_ENABLED_UNIVERSAL_GROUP_CHANGED"},{"pattern":"4756","format":"MEMBER_ADDED_TO_SECURITY_ENABLED_UNIVERSAL_GROUP"},{"pattern":"4757","format":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_UNIVERSAL_GROUP"},{"pattern":"4758","format":"SECURITY_ENABLED_UNIVERSAL_GROUP_DELETED"},{"pattern":"4764","format":"GROUP_TYPE_CHANGED"},{"pattern":"4767","format":"USER_ACCOUNT_UNLOCKED"},{"pattern":"4794","format":"ATTEMPT_MADE_TO_SET_DIRECTORY_SERVICES_RESTORE_MODE_ADMINISTRATOR_PASSWORD"},{"pattern":"5136","format":"DIRECTORY_SERVICE_OBJECT_MODIFIED"},{"pattern":"5376","format":"CREDENTIAL_MANAGER_CREDENTIALS_BACKED_UP"},{"pattern":"5377","format":"CREDENTIAL_MANAGER_CREDENTIALS_RESTORED_FROM_BACKUP"}]}

### Add operationTypeCategories according to operationType ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonConditionalArrayPopulatorInterceptor.type=org.apache.flume.interceptor.presidio.conditionalarraypopulator.JsonConditionalArrayPopulatorInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonConditionalArrayPopulatorInterceptor.configuration={"sourceKey":"operationType","destinationKey":"operationTypeCategory","conditionAndArrayValuesList":[{"pattern":"COMPUTER_ACCOUNT_CREATED","values":["COMPUTER_MANAGEMENT"]},{"pattern":"COMPUTER_ACCOUNT_CHANGED","values":["COMPUTER_MANAGEMENT"]},{"pattern":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_LOCAL_GROUP","values":["GROUP_MEMBERSHIP_REMOVE_OPERATION"]},{"pattern":"SECURITY_ENABLED_LOCAL_GROUP_DELETED","values":["GROUP_MANAGEMENT"]},{"pattern":"SECURITY_ENABLED_LOCAL_GROUP_CHANGED","values":["GROUP_MANAGEMENT"]},{"pattern":"SECURITY_ENABLED_UNIVERSAL_GROUP_CHANGED","values":["GROUP_MANAGEMENT"]},{"pattern":"ATTEMPT_MADE_TO_SET_DIRECTORY_SERVICES_RESTORE_MODE_ADMINISTRATOR_PASSWORD","values":["OBJECT_MANAGEMENT"]},{"pattern":"CREDENTIAL_MANAGER_CREDENTIALS_BACKED_UP","values":["OBJECT_MANAGEMENT"]},{"pattern":"CREDENTIAL_MANAGER_CREDENTIALS_RESTORED_FROM_BACKUP","values":["OBJECT_MANAGEMENT"]},{"pattern":"DIRECTORY_SERVICE_OBJECT_MODIFIED","values":["OBJECT_MANAGEMENT"]},{"pattern":"GROUP_TYPE_CHANGED","values":["GROUP_MANAGEMENT"]},{"pattern":"PERMISSIONS_ON_OBJECT_CHANGED","values":["OBJECT_MANAGEMENT"]},{"pattern":"COMPUTER_ACCOUNT_DELETED","values":["COMPUTER_MANAGEMENT"]},{"pattern":"DOMAIN_POLICY_CHANGED","values":["DOMAIN_MANAGEMENT"]},{"pattern":"SECURITY_ENABLED_GLOBAL_GROUP_CHANGED","values":["GROUP_MANAGEMENT"]},{"pattern":"SECURITY_ENABLED_GLOBAL_GROUP_CREATED","values":["GROUP_MANAGEMENT"]},{"pattern":"MEMBER_ADDED_TO_SECURITY_ENABLED_GLOBAL_GROUP","values":["GROUP_MEMBERSHIP_ADD_OPERATION"]},{"pattern":"SECURITY_ENABLED_UNIVERSAL_GROUP_CREATED","values":["GROUP_MANAGEMENT"]},{"pattern":"MEMBER_ADDED_TO_SECURITY_ENABLED_UNIVERSAL_GROUP","values":["GROUP_MEMBERSHIP_ADD_OPERATION"]},{"pattern":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_UNIVERSAL_GROUP","values":["GROUP_MEMBERSHIP_REMOVE_OPERATION"]},{"pattern":"SECURITY_ENABLED_UNIVERSAL_GROUP_DELETED","values":["GROUP_MANAGEMENT"]},{"pattern":"USER_ACCOUNT_CREATED","values":["USER_MANAGEMENT"]},{"pattern":"USER_ACCOUNT_DELETED","values":["USER_MANAGEMENT"]},{"pattern":"USER_ACCOUNT_CHANGED","values":["USER_MANAGEMENT"]},{"pattern":"SYSTEM_SECURITY_ACCESS_GRANTED_TO_ACCOUNT","values":["OBJECT_MANAGEMENT"]},{"pattern":"MEMBER_REMOVED_FROM_SECURITY_ENABLED_GLOBAL_GROUP","values":["GROUP_MEMBERSHIP_REMOVE_OPERATION"]},{"pattern":"SECURITY_ENABLED_GLOBAL_GROUP_DELETED","values":["GROUP_MANAGEMENT"]},{"pattern":"SECURITY_ENABLED_LOCAL_GROUP_CREATED","values":["GROUP_MANAGEMENT"]},{"pattern":"MEMBER_ADDED_TO_SECURITY_ENABLED_LOCAL_GROUP","values":["GROUP_MEMBERSHIP_ADD_OPERATION"]}]}

### Add objectId from a varying NetWitness metadata key according to reference_id ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.origin_field=reference_id
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.destination_field=objectId
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.cases_delim=,
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.cases=4741,4742,4733,4734,4735,4755,4740,5136,4764,4670,4743,4737,4727,4728,4754,4756,4757,4758,4720,4722,4723,4724,4725,4726,4738,4767,4717,4729,4730,4731,4732
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorObjectId.cases_values=${user_src};${user_src};${user_src};${group};${group};${group};${user_src};${obj_name};${group};${obj_name};${user_src};${group};${group};${user_src};${group};${user_src};${user_src};${group};${user_src};${user_src};${user_src};${user_src};${user_src};${user_src};${user_src};${user_src};${user_src};${user_src};${group};${group};${user_src}

### Add additionalInfo from a varying NetWitness metadata key according to reference_id ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.origin_field=reference_id
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.destination_field=additionalInfo.secondaryObjectId
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.cases_delim=,
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.cases=4733,4728,4756,4757,4717,4729,4732
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptorAdditionalInfo.cases_values=${group};${group};${group};${group};${accesses};${group};${group}

### Add dateTime according to event_time, and convert it to epoch in seconds ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEpochInterceptor.type=org.apache.flume.interceptor.presidio.JsonEpochInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEpochInterceptor.originField=event_time
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEpochInterceptor.originFormat=MILLIS
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonEpochInterceptor.destinationField=dateTime

### Add userId according to user_dst, and normalize it ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.configuration={"sourceKey":"user_dst","destinationKey":"userId","captureAndFormatConfigurations":[{"pattern":"CN=([^,]+)","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"CN=([^,]+),.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\\\\\)+(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\\\\\)+([^@]+)","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":".+","format":"%s","capturingGroupConfigurations":[{"index":0,"caseFormat":"LOWER"}]}]}

### Add result according to event_type, and normalize it ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorResult.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorResult.configuration={"sourceKey":"event_type","destinationKey":"result","captureAndFormatConfigurations":[{"pattern":".*(?i:fail).*","format":"FAILURE"},{"pattern":".*(?i:succ).*","format":"SUCCESS"}]}

### Duplicate user_dst to userName and userDisplayName ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldDuplicatorInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.originFieldsList=user_dst,user_dst
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.destinationFieldsList=userName,userDisplayName

### Rename NetWitness metadata key names to Presidio schema field names ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldRenamerInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.originFieldsList=event_source_id,reference_id
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.destinationFieldsList=eventId,dataSource

############################## CHANNEL ##############################
nwActive_directoryAgent.channels.memoryChannel.type=memory
nwActive_directoryAgent.channels.memoryChannel.capacity=100000
nwActive_directoryAgent.channels.memoryChannel.transactionCapacity=10000
############################## SINK ##############################
nwActive_directoryAgent.sinks.inputSdkSink.channel=memoryChannel
nwActive_directoryAgent.sinks.inputSdkSink.type=org.flume.sink.input.PresidioInputSdkSink
nwActive_directoryAgent.sinks.inputSdkSink.schema=ACTIVE_DIRECTORY
nwActive_directoryAgent.sinks.inputSdkSink.recordType=presidio.sdk.api.domain.rawevents.ActiveDirectoryRawEvent
nwActive_directoryAgent.sinks.inputSdkSink.isBatch=true
nwActive_directoryAgent.sinks.inputSdkSink.batchSize=1000
nwActive_directoryAgent.sinks.inputSdkSink.applicationName=adapter
