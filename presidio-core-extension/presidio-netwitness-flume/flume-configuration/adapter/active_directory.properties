# Flume agent for the adapter component
# The source reads data from the NetWitness SDK within a given time range
# Date format: yyyy-MM-ddTHH:mm:ssZ (e.g. 2015-01-01T00:00:01Z)
# Channel stores in file up to 10K records
# The sink writes the records using the input SDK
############################## AGENT ##############################
nwActive_directoryAgent.sources=sdkSource
nwActive_directoryAgent.channels=memoryChannel
nwActive_directoryAgent.sinks=inputSdkSink
############################## SOURCE ##############################
nwActive_directoryAgent.sources.sdkSource.channels=memoryChannel
nwActive_directoryAgent.sources.sdkSource.streamImplClassName=presidio.nw.flume.sdk.NetwitnessEventsStream
nwActive_directoryAgent.sources.sdkSource.type=org.flume.source.sdk.PresidioStreamingSDKSource
nwActive_directoryAgent.sources.sdkSource.schema=ACTIVE_DIRECTORY
nwActive_directoryAgent.sources.sdkSource.startDate=$startDate
nwActive_directoryAgent.sources.sdkSource.endDate=$endDate
nwActive_directoryAgent.sources.sdkSource.query=select * where device.type = 'winevent_snare' && reference.id = '4741','4742','4733','4734','4735','4755','4740','4794','5376','5377','5136','4764','4670','4743','4739','4737','4727','4728','4754','4756','4757','4758','4720','4722','4723','4724','4725','4726','4738','4767','4717','4729','4730','4731','4732' && user.dst regex '^[^\\$]*$'
#nwActive_directoryAgent.sources.sdkSource.query=select * where reference.id = '4741','4742','4733','4734','4735','4755','4740','4794','5376','5377','5136','4764','4670','4743','4739','4737','4727','4728','4754','4756','4757','4758','4720','4722','4723','4724','4725','4726','4738','4767','4717','4729','4730','4731','4732'
nwActive_directoryAgent.sources.sdkSource.timeField=event.time
nwActive_directoryAgent.sources.sdkSource.batchSize=1000
nwActive_directoryAgent.sources.sdkSource.isBatch=true
nwActive_directoryAgent.sources.sdkSource.applicationName=adapter
############################## INTERCEPTORS ##############################
nwActive_directoryAgent.sources.sdkSource.interceptors=epochInterceptor jsonFieldRenamerInterceptor jsonRegexCaptureAndFormatInterceptorUserId jsonFieldValueReplacerInterceptor jsonRegexCaptureAndFormatInterceptorResult jsonFieldDuplicatorInterceptor jsonFieldSwitchCaseInterceptor

### Convert time field from EPOCH millis to EPOCH seconds
nwActive_directoryAgent.sources.sdkSource.interceptors.epochInterceptor.type=org.apache.flume.interceptor.presidio.JsonEpochInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.epochInterceptor.originField=event_time
nwActive_directoryAgent.sources.sdkSource.interceptors.epochInterceptor.originFormat=MILLIS
nwActive_directoryAgent.sources.sdkSource.interceptors.epochInterceptor.destinationField=event_time

### Rename NetWitness metadata key names to Presidio schema field names ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldRenamerInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.originFieldsList=event_source_id,event_time,user_dst,reference_id,event_type
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldRenamerInterceptor.destinationFieldsList=eventId,dateTime,userId,operationType,result

### Normalize the userId values ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorUserId.configuration={"sourceKey":"userId","destinationKey":"userId","captureAndFormatConfigurations":[{"pattern":"CN=([^,]+)","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"CN=([^,]+),.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\)+(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+\\\\)+([^@]+)","format":"%s","capturingGroupConfigurations":[{"index":2,"caseFormat":"LOWER"}]},{"pattern":"(.+)@.+","format":"%s","capturingGroupConfigurations":[{"index":1,"caseFormat":"LOWER"}]},{"pattern":".+","format":"%s","capturingGroupConfigurations":[{"index":0,"caseFormat":"LOWER"}]}]}

### Map reference ID values to operation type values ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldValueReplacerInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldValueReplacerInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldValueReplacerInterceptor.replacements=operationType#4670>PERMISSIONS_ON_OBJECT_CHANGED,operationType#4717>SYSTEM_SECURITY_ACCESS_GRANTED_TO_ACCOUNT,operationType#4720>USER_ACCOUNT_CREATED,operationType#4722>USER_ACCOUNT_ENABLED,operationType#4723>USER_PASSWORD_CHANGED,operationType#4724>USER_PASSWORD_RESET,operationType#4725>USER_ACCOUNT_DISABLED,operationType#4726>USER_ACCOUNT_DELETED,operationType#4727>SECURITY_ENABLED_GLOBAL_GROUP_CREATED,operationType#4728>MEMBER_ADDED_TO_SECURITY_ENABLED_GLOBAL_GROUP,operationType#4729>MEMBER_REMOVED_FROM_SECURITY_ENABLED_GLOBAL_GROUP,operationType#4730>SECURITY_ENABLED_GLOBAL_GROUP_DELETED,operationType#4731>SECURITY_ENABLED_LOCAL_GROUP_CREATED,operationType#4732>MEMBER_ADDED_TO_SECURITY_ENABLED_LOCAL_GROUP,operationType#4733>MEMBER_REMOVED_FROM_SECURITY_ENABLED_LOCAL_GROUP,operationType#4734>SECURITY_ENABLED_LOCAL_GROUP_DELETED,operationType#4735>SECURITY_ENABLED_LOCAL_GROUP_CHANGED,operationType#4737>SECURITY_ENABLED_GLOBAL_GROUP_CHANGED,operationType#4738>USER_ACCOUNT_CHANGED,operationType#4739>DOMAIN_POLICY_CHANGED,operationType#4740>USER_ACCOUNT_LOCKED,operationType#4741>COMPUTER_ACCOUNT_CREATED,operationType#4742>COMPUTER_ACCOUNT_CHANGED,operationType#4743>COMPUTER_ACCOUNT_DELETED,operationType#4754>SECURITY_ENABLED_UNIVERSAL_GROUP_CREATED,operationType#4755>SECURITY_ENABLED_UNIVERSAL_GROUP_CHANGED,operationType#4756>MEMBER_ADDED_TO_SECURITY_ENABLED_UNIVERSAL_GROUP,operationType#4757>MEMBER_REMOVED_FROM_SECURITY_ENABLED_UNIVERSAL_GROUP,operationType#4758>SECURITY_ENABLED_UNIVERSAL_GROUP_DELETED,operationType#4764>GROUP_TYPE_CHANGED,operationType#4767>USER_ACCOUNT_UNLOCKED,operationType#4794>ATTEMPT_MADE_TO_SET_DIRECTORY_SERVICES_RESTORE_MODE_ADMINISTRATOR_PASSWORD,operationType#5136>DIRECTORY_SERVICE_OBJECT_MODIFIED,operationType#5376>CREDENTIAL_MANAGER_CREDENTIALS_BACKED_UP,operationType#5377>CREDENTIAL_MANAGER_CREDENTIALS_RESTORED_FROM_BACKUP

### Normalize the result values ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorResult.type=org.apache.flume.interceptor.presidio.regexcaptureandformat.JsonRegexCaptureAndFormatInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonRegexCaptureAndFormatInterceptorResult.configuration={"sourceKey":"result","destinationKey":"result","captureAndFormatConfigurations":[{"pattern":".*(?i:fail).*","format":"FAILURE"},{"pattern":".*(?i:succ).*","format":"SUCCESS"}]}

### Copy userId to userName ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldDuplicatorInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.originFieldsList=userId
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldDuplicatorInterceptor.destinationFieldsList=userName

### Conditional mapping from a NetWitness metadata key to Presidio's objectId schema field ###
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.type=org.apache.flume.interceptor.presidio.JsonFieldSwitchCaseInterceptor$Builder
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.origin_field=operationType
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.destination_field=objectId
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.cases_delim=,
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.cases=COMPUTER_ACCOUNT_CREATED,COMPUTER_ACCOUNT_CHANGED,MEMBER_REMOVED_FROM_SECURITY_ENABLED_LOCAL_GROUP,SECURITY_ENABLED_LOCAL_GROUP_DELETED,SECURITY_ENABLED_LOCAL_GROUP_CHANGED,SECURITY_ENABLED_UNIVERSAL_GROUP_CHANGED,USER_ACCOUNT_LOCKED,DIRECTORY_SERVICE_OBJECT_MODIFIED,GROUP_TYPE_CHANGED,PERMISSIONS_ON_OBJECT_CHANGED,COMPUTER_ACCOUNT_DELETED,SECURITY_ENABLED_GLOBAL_GROUP_CHANGED,SECURITY_ENABLED_GLOBAL_GROUP_CREATED,MEMBER_ADDED_TO_SECURITY_ENABLED_GLOBAL_GROUP,SECURITY_ENABLED_UNIVERSAL_GROUP_CREATED,MEMBER_ADDED_TO_SECURITY_ENABLED_UNIVERSAL_GROUP,MEMBER_REMOVED_FROM_SECURITY_ENABLED_UNIVERSAL_GROUP,SECURITY_ENABLED_UNIVERSAL_GROUP_DELETED,USER_ACCOUNT_CREATED,USER_ACCOUNT_ENABLED,USER_PASSWORD_CHANGED,USER_PASSWORD_RESET,USER_ACCOUNT_DISABLED,USER_ACCOUNT_DELETED,USER_ACCOUNT_CHANGED,USER_ACCOUNT_UNLOCKED,SYSTEM_SECURITY_ACCESS_GRANTED_TO_ACCOUNT,MEMBER_REMOVED_FROM_SECURITY_ENABLED_GLOBAL_GROUP,SECURITY_ENABLED_GLOBAL_GROUP_DELETED,SECURITY_ENABLED_LOCAL_GROUP_CREATED,MEMBER_ADDED_TO_SECURITY_ENABLED_LOCAL_GROUP
nwActive_directoryAgent.sources.sdkSource.interceptors.jsonFieldSwitchCaseInterceptor.cases_values=${user.src};${user.src};${user.src};${group};${group};${group};${user.src};${obj.name};${group};${obj.name};${user.src};${group};${group};${user.src};${group};${user.src};${user.src};${group};${user.src};${user.src};${user.src};${user.src};${user.src};${user.src};${user.src};${user.src};${user.src};${user.src};${group};${group};${user.src}


# TODO: Conditional mapping from a NetWitness metadata key to Presidio's additionalInfo schema field
# TODO: Populate operationTypeCategories list according to reference ID / operation type
############################## CHANNEL ##############################
nwActive_directoryAgent.channels.memoryChannel.type=memory
nwActive_directoryAgent.channels.memoryChannel.capacity=100000
nwActive_directoryAgent.channels.memoryChannel.transactionCapacity=10000
############################## SINK ##############################
nwActive_directoryAgent.sinks.inputSdkSink.channel=memoryChannel
nwActive_directoryAgent.sinks.inputSdkSink.type=org.flume.sink.input.PresidioInputSdkSink
nwActive_directoryAgent.sinks.inputSdkSink.schema=ACTIVE_DIRECTORY
nwActive_directoryAgent.sinks.inputSdkSink.recordType=presidio.sdk.api.domain.rawevents.ActiveDirectoryRawEvent
nwActive_directoryAgent.sinks.inputSdkSink.isBatch=true
nwActive_directoryAgent.sinks.inputSdkSink.batchSize=1000
nwActive_directoryAgent.sinks.inputSdkSink.applicationName=adapter
