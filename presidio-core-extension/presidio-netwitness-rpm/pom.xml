<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>presidio.netwitness</groupId>
        <artifactId>presidio-netwitness</artifactId>
        <version>2.0.0-SNAPSHOT</version>
    </parent>

    <artifactId>presidio-netwitness-rpm</artifactId>

    <properties>
        <presidio_home_path>/home/presidio/presidio-core/</presidio_home_path>
        <tomcat_webapps_path>/opt/tomcat/webapps</tomcat_webapps_path>
        <flume_home_directory>/opt/flume/</flume_home_directory>
        <rpm-maven-plugin.deployment_target_directory>/home/presidio/presidio-core
        </rpm-maven-plugin.deployment_target_directory>
        <rpm-maven-plugin.workflows-build-script-path>${project.basedir}/build-scripts/build-workflows.sh
        </rpm-maven-plugin.workflows-build-script-path>
        <rpm-maven-plugin.workflows_packages_directory>${rpm-maven-plugin.deployment_target_directory}/netwitness-packages
        </rpm-maven-plugin.workflows_packages_directory>
        <airflow.deployment_target_directory>${rpm-maven-plugin.deployment_target_directory}/airflow
        </airflow.deployment_target_directory>
        <presidio-workflows-src.location>
            ${project.parent.build.directory}/../../presidio-workflows-extension/presidio_extension
        </presidio-workflows-src.location>
        <rpm-maven-plugin.resources>${rpm-maven-plugin.deployment_target_directory}/netwitness/resources
        </rpm-maven-plugin.resources>
        <rpm-maven-plugin.directory>${rpm-maven-plugin.deployment_target_directory}/netwitness/installation
        </rpm-maven-plugin.directory>
        <rpm-maven-plugin.workflows-upgrade-script-path>
            ${rpm-maven-plugin.directory}/installation-scripts/utils/deploy_presidio_workflows_package.sh
        </rpm-maven-plugin.workflows-upgrade-script-path>
    </properties>
    <build>
        <plugins>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <executions>
                    <execution>
                        <id>build workflows</id>
                        <phase>generate-sources</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <executable>${rpm-maven-plugin.workflows-build-script-path}</executable>
                            <arguments>
                                <argument>
                                    ${rpm.version.build}
                                </argument>
                            </arguments>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>rpm-maven-plugin</artifactId>
                <version>${rpm-maven-plugin.version}</version>
                <extensions>true</extensions>
                <executions>
                    <execution>
                        <id>generate-rpm</id>
                        <goals>
                            <goal>rpm</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <group>Application/Collectors</group>
                    <release>${rpm.version.build}</release>
                    <needarch>true</needarch>
                    <requires>
                        <require>presidio-core &gt;= 1.0</require>
                    </requires>
                    <mappings>
                        <mapping>
                            <directoryIncluded>false</directoryIncluded>
                            <directory>${flume_home_directory}/plugins.d/PresidioStreamingSource/libext</directory>
                            <username>presidio</username>
                            <groupname>presidio</groupname>
                            <sources>
                                <source>
                                    <location>${project.basedir}/../presidio-netwitness-flume/target/libext/</location>
                                </source>
                            </sources>
                        </mapping>
                        <mapping>
                            <directoryIncluded>false</directoryIncluded>
                            <directory>${flume_home_directory}/plugins.d/PresidioStreamingSource/lib</directory>
                            <username>presidio</username>
                            <groupname>presidio</groupname>
                            <sources>
                                <source>
                                    <location>
                                        ${project.basedir}/../presidio-netwitness-flume/target/presidio-netwitness-flume-${project.version}.jar
                                    </location>
                                </source>
                            </sources>
                        </mapping>
                        <mapping>
                            <!--Elastic Search Scripts Mappings-->
                            <directoryIncluded>true</directoryIncluded>
                            <directory>${rpm-maven-plugin.deployment_target_directory}/installation/installation-scripts/vendor</directory>
                            <username>presidio</username>
                            <groupname>presidio</groupname>
                            <sources>
                                <source>
                                    <location>${project.basedir}/src/main/python/installation-scripts/elasticsearch</location>
                                </source>
                            </sources>
                        </mapping>
                        <mapping>
                            <directoryIncluded>false</directoryIncluded>
                            <directory>${flume_home_directory}/conf/adapter</directory>
                            <username>presidio</username>
                            <groupname>presidio</groupname>
                            <sources>
                                <source>
                                    <location>
                                        ${project.basedir}/../presidio-netwitness-flume/target/flume-configuration/adapter/
                                    </location>
                                </source>
                            </sources>
                        </mapping>
                        <!--<mapping>-->
                            <!-- package presidio workflows library-->
                            <!--<directoryIncluded>false</directoryIncluded>-->
                            <!--<directory>${rpm-maven-plugin.workflows_packages_directory}</directory>-->
                            <!--<username>presidio</username>-->
                            <!--<groupname>presidio</groupname>-->
                            <!--<sources>-->
                                <!--<source>-->
                                    <!--<location>${project.build.directory}/eggs</location>-->
                                <!--</source>-->
                            <!--</sources>-->
                        <!--</mapping>-->
                    </mappings>
                    <preinstallScriptlet>
                        <script>
                            <!-- pre installation commands: -->
                            echo "Stopping Tomcat"
                            systemctl stop tomcat.service

                            echo "Removing core's webapp - TEMPORARY"
                            rm -rf /opt/tomcat/webapps/presidio-manager*


                            <!-- end of pre installation -->
                        </script>
                    </preinstallScriptlet>
                    <postinstallScriptlet>
                        <script>
                            <!-- post installation commands: -->

                            <!-- Temp mongo db creation block -->
                            echo "Stopping mongo service"
                            systemctl stop mongod.service
                            wait ${!}
                            echo "Disabling mongo auth"
                            rm -rf -v /etc/mongod.conf
                            cp -v /etc/mongod.conf.no_auth /etc/mongod.conf
                            echo "Starting mongo service"
                            systemctl start mongod.service
                            wait ${!}
                            echo "Mongo: creating presidio user"
                            sleep 5
                            echo "Stopping mongo service"
                            systemctl stop mongod.service
                            wait ${!}
                            echo "Enabling mongo auth"
                            rm -rf -v /etc/mongod.conf
                            cp -v /etc/mongod.conf.auth /etc/mongod.conf
                            echo "Starting mongo service"
                            systemctl start mongod.service
                            <!-- End of mongo db creation -->


                            chown -v -R presidio:presidio ${flume_home_directory}

                            <!--always upgrade presidio-workflows python package-->
                            echo "Upgrading presidio workflows extension"
                            bash ${rpm-maven-plugin.workflows-upgrade-script-path}

                            echo "Restarting airflow"
                            systemctl restart airflow-webserver

                            echo "Restarting tomcat"
                            systemctl restart tomcat.service
                            <!--end of post installation -->
                        </script>
                    </postinstallScriptlet>
                    <preremoveScriptlet>
                        <script>
                            <!-- pre remove commands -->
                        </script>
                    </preremoveScriptlet>
                    <postremoveScriptlet>
                        <script>
                            <!-- post remove commands -->
                            rm -rf -v ${flume_home_directory}/plugins.d
                            rm -rf -v ${flume_home_directory}/conf/adapter
                        </script>
                    </postremoveScriptlet>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>