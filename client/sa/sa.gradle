ext {
    createRPM = true
}

task emberGenerateShim(type: NodeTask, dependsOn: [":client:component-lib:emberBuild"]) {
    script = ember
    args = ["build", "generate", "ember-cli-es5-shim", "--silent"]
}

task emberFixturedBuild(type: NodeTask, dependsOn: ["test"]) {
    script = ember
    args = ["build", "-e", "fixtured", "-o", "dist/fixtured", "--silent"]
}

task fixtured(type: Zip, dependsOn: ["emberFixturedBuild"]) {
    destinationDir file(project.buildDir)
    archiveName "sa-ui-fixtured.zip"

    from("dist/fixtured") {
        include "**/*"
    }
}

afterEvaluate {
    rpm {
        dependsOn("emberBuild")

        packageName "sa-ui-client"

        requires("nginx")

        postInstall file("${projectDir}/rpm/scripts/postInstall.sh")

        from(fileTree("rpm/nginx")) {
            fileType CONFIG
            into "/etc/nginx"
        }

        from(fileTree("dist/production")) {
            into "/opt/rsa/sa-ui/html"
        }
    }
}

test.dependsOn(["emberGenerateShim"])
emberBuild.dependsOn("fixtured", ":client:component-lib:emberBuild")
